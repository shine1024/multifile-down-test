<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íŒŒì¼ ìë™ ì—…ë¡œë“œ â†’ ë³µí˜¸í™” ë‹¤ìš´ë¡œë“œ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
        }

        .drop-zone {
            border: 3px dashed #999;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            color: #666;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .drop-zone.dragover {
            background-color: #f0f8ff;
            border-color: #007bff;
            color: #007bff;
        }

        #status {
            margin-top: 15px;
            color: #007bff;
            font-weight: bold;
        }
    </style>
</head>
<body>

<h2>ğŸ“‚ ì•”í˜¸í™”ëœ íŒŒì¼ ë“œë˜ê·¸ì•¤ë“œë â†’ ë³µí˜¸í™” ë‹¤ìš´ë¡œë“œ</h2>

<div id="dropZone" class="drop-zone">
    ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”.
</div>

<div id="status"></div>

<script>
    const dropZone = document.getElementById('dropZone');
    const statusText = document.getElementById('status');

    // === ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì²˜ë¦¬ ===
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', async (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
            await uploadAndDownload(files);
        }
    });

    // === í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ ===
    dropZone.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.multiple = true;
        input.onchange = async (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                await uploadAndDownload(files);
            }
        };
        input.click();
    });

    // === ì„œë²„ ì—…ë¡œë“œ í›„ ìë™ ë‹¤ìš´ë¡œë“œ ===
    async function uploadAndDownload(files) {
        statusText.textContent = 'ì„œë²„ë¡œ ì „ì†¡ ì¤‘...';

        for (const file of files) {
            const formData = new FormData();
            formData.append('files', file);

            try {
                const response = await fetch('/api/decrypt', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    console.error('âŒ ì„œë²„ ì˜¤ë¥˜:', response.status);
                    continue;
                }

                // ì„œë²„ì—ì„œ ë³µí˜¸í™”ëœ íŒŒì¼ì„ ì‘ë‹µ
                const blob = await response.blob();
                const disposition = response.headers.get('Content-Disposition');
                let filename = 'decoded_' + file.name;

                if (disposition) {
                    const utf8Match = disposition.match(/filename\*=UTF-8''([^;]+)/);
                    const asciiMatch = disposition.match(/filename="([^"]+)"/);
                    if (utf8Match) {
                        filename = decodeURIComponent(utf8Match[1]);
                    } else if (asciiMatch) {
                        filename = asciiMatch[1];
                    }
                }

                // ìë™ ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);

                console.log(`âœ… ${filename} ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`);
            } catch (err) {
                console.error('âš ï¸ ì˜¤ë¥˜:', err.message);
            }
        }

        statusText.textContent = 'âœ… ëª¨ë“  íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ';
    }
</script>

</body>
</html>
